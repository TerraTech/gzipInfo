//==============================================================================
// This file is part of FQgolibs
// Copyright (c) 2017, FutureQuest, Inc.
//   https://www.FutureQuest.net
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//==============================================================================

// +build ignore

package main

import (
	"flag"
	"fmt"
	"log"
	"os"
	"path/filepath"
	gott "text/template"
	"time"
)

type vtype int

const (
	VTYPE_APP vtype = iota
	VTYPE_LIB
)

const (
	IMPORT_FMT = "fmt"
	IMPORT_FQversion = "futurequest.net/FQgolibs/FQversion"
	IMPORT_NL = "\n"
)

type VersionTemplate struct {
	Timestamp time.Time
	PACKAGE   string
	PROG      string
	VERSION   string
	BUILD     string
	LIB       string
	Imports   []string
	FQversion string
}

func usage() {
	fmt.Printf("usage: %s -package -prog -version -build [-lib]\n", filepath.Base(os.Args[0]))
	os.Exit(1)
}

func main() {
	var vtype vtype = VTYPE_APP
	vt := &VersionTemplate{
		Timestamp: time.Now(),
	}

	flag.StringVar(&vt.PACKAGE, "package", "", "package name")
	flag.StringVar(&vt.PROG, "prog", "", "prog/lib name")
	flag.StringVar(&vt.VERSION, "version", "", "version string")
	flag.StringVar(&vt.BUILD, "build", "", "build string")
	flag.StringVar(&vt.LIB, "lib", "", "type name for Version() method receiver")
	flag.Parse()

	mustExist := func(name, val string) {
		if val == "" {
			fmt.Printf("%s must be specified\n", name)
			usage()
		}
	}

	// must exist for all
	mustExist("package", vt.PACKAGE)
	mustExist("prog", vt.PROG)
	mustExist("version", vt.VERSION)
	mustExist("build", vt.BUILD)

	if vt.LIB != "" {
		vtype = VTYPE_LIB
	}

	if vt.PACKAGE != "FQversion" {
		vt.FQversion = "FQversion."
	}

	template := vt.getTemplate(vtype)
	if template == nil {
		log.Fatal("template parsing failed: %s", vtype)
	}

	f, err := os.Create("version_autogen.go")
	die(err)
	defer f.Close()

	template.Execute(f, vt)
}

func (v *vtype) String() string {
	switch *v {
	case VTYPE_APP: return "app"
	case VTYPE_LIB: return "lib"
	}
	return ""
}

func die(err error) {
	if err != nil {
		log.Fatal(err)
	}
}

func (vt *VersionTemplate) getTemplate(vtype vtype) *gott.Template {
	var template string
	switch vtype {
	case VTYPE_APP:
		template = vt.getTemplateApp()
	case VTYPE_LIB:
		template = vt.getTemplateLib()
	default:
		log.Fatal("unrecognized template type: %s", vtype)
	}

	return gott.Must(gott.New("").Parse(template))
}

func (vt *VersionTemplate) getTemplateLib() string {
	vt.Imports = append(vt.Imports,
		IMPORT_FQversion,
	)
	template := getTemplateHeader()
	template += `
func init() {
	{{ .FQversion }}Register(PROG, VERSION, BUILD)
}
{{ if .FQversion }}
func Version() string {
	return FQversion.ProgVersion(PROG, VERSION, BUILD)
}
{{ end -}}
`

	return template
}

func (vt *VersionTemplate) getTemplateApp() string {
	vt.Imports = append(vt.Imports,
		IMPORT_FMT,
		IMPORT_NL,
		IMPORT_FQversion,
	)
	template := getTemplateHeader()
	template += `
func Version() string {
	return FQversion.ProgVersion(PROG, VERSION, BUILD)
}
{{ if ne .PROG "FQgolibs" }}
func printVersions() {
	fmt.Println(FQversion.ShowVersionsAligned(PROG, VERSION, BUILD))
}
{{ end -}}
`
	return template
}

func getTemplateHeader() string {
	return `//==============================================================================
// This file is part of {{ .PACKAGE }}
// Copyright (c) 2017, FutureQuest, Inc.
//   https://www.FutureQuest.net
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//==============================================================================

// Code generated by go generate; DO NOT EDIT.
// This file was generated by genVersion at
// {{ .Timestamp }}

package {{ .PACKAGE }}
{{ if .Imports }}
import (
	{{- range .Imports }}
{{ if eq . "\n"}}{{else}}	"{{ . }}"{{end}}
	{{- end }}
)
{{ end }}
var (
	PROG    string = "{{ .PROG }}"
	VERSION string = "{{ .VERSION }}"
	BUILD   string = "{{ .BUILD }}"
)
`
}
